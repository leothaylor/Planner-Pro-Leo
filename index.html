<!DOCTYPE html>
<html lang="pt-br" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Planner Pro — Semana</title>
  <meta name="description" content="Planner semanal com agenda, checklist, Pomodoro, exportação e tema dark/light." />
  <meta name="theme-color" content="#06b6d4" />
  <link rel="icon" href="icons/icon-192.png" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <link rel="manifest" href="manifest.webmanifest" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class' };</script>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root { --ring: 0 255 255; }
    html { scroll-behavior: smooth }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial }
    *:focus { outline: none }
    .focus-ring:focus-visible { box-shadow: 0 0 0 3px rgba(6, 182, 212, .55) }
    [aria-hidden="true"] { visibility: hidden }
  </style>
</head>
<body class="bg-slate-950 text-slate-100">
  <div id="root"></div>

  <script type="text/babel">
    // ===== Utils =====
    const startOfWeek = (d)=>{ const x=new Date(d); const day=(x.getDay()+6)%7; const r=new Date(x); r.setDate(x.getDate()-day); r.setHours(0,0,0,0); return r; };
    const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x; };
    const fmtISO = (d)=>{ const t=new Date(d); t.setMinutes(t.getMinutes()-t.getTimezoneOffset()); return t.toISOString().slice(0,10); };
    const fmtHumano = (d)=> d.toLocaleDateString("pt-BR",{weekday:"short",day:"2-digit",month:"2-digit"});
    const genId = ()=> Math.random().toString(36).slice(2,9); // ID generator moved to utils

    // ===== Cores / Prioridade =====
    const PRIORITY={ high:{text:"text-rose-500",bar:"bg-rose-500",ring:"ring-rose-500/50"}, medium:{text:"text-amber-500",bar:"bg-amber-500",ring:"ring-amber-500/50"}, low:{text:"text-emerald-500",bar:"bg-emerald-500",ring:"ring-emerald-500/50"} };
    const CATEGORIES=[ "Treino – Peito","Treino – Costas","Treino – Pernas","Treino – Ombros","Treino – Bíceps","Treino – Tríceps","Cardio","Alongamento","Mobilidade","Medicação","Consulta","Exame","Sono/Rotina","Estudo – ENEM","Estudo – Medicina","Leitura Técnica","Revisão/Flashcards","Projeto 60","Trabalho – ACS","Trabalho – Barbeiro","Gravar Vídeo (Sora/Veo)","Edição Vídeo","Roteiro","Design/Canva","Financeiro","Doméstico","Compras","Administração","Deslocamento","Social/Lazer" ];
    const CAT_COLORS={ "Treino – Peito":"emerald","Treino – Costas":"emerald","Treino – Pernas":"emerald","Treino – Ombros":"emerald","Treino – Bíceps":"emerald","Treino – Tríceps":"emerald","Cardio":"sky","Alongamento":"teal","Mobilidade":"teal","Medicação":"rose","Consulta":"rose","Exame":"rose","Sono/Rotina":"slate","Estudo – ENEM":"violet","Estudo – Medicina":"violet","Leitura Técnica":"indigo","Revisão/Flashcards":"indigo","Projeto 60":"cyan","Trabalho – ACS":"amber","Trabalho – Barbeiro":"amber","Gravar Vídeo (Sora/Veo)":"fuchsia","Edição Vídeo":"fuchsia","Roteiro":"fuchsia","Design/Canva":"pink","Financeiro":"lime","Doméstico":"orange","Compras":"orange","Administração":"yellow","Deslocamento":"blue","Social/Lazer":"green" };
    function colorClass(cat){ const c=CAT_COLORS[cat]||"slate"; const map={ emerald:{pill:"bg-emerald-500/20 text-emerald-700 border-emerald-400/30"}, sky:{pill:"bg-sky-500/20 text-sky-700 border-sky-400/30"}, teal:{pill:"bg-teal-500/20 text-teal-700 border-teal-400/30"}, rose:{pill:"bg-rose-500/20 text-rose-700 border-rose-400/30"}, slate:{pill:"bg-slate-500/20 text-slate-700 border-slate-400/30"}, violet:{pill:"bg-violet-500/20 text-violet-700 border-violet-400/30"}, indigo:{pill:"bg-indigo-500/20 text-indigo-700 border-indigo-400/30"}, cyan:{pill:"bg-cyan-500/20 text-cyan-700 border-cyan-400/30"}, amber:{pill:"bg-amber-500/20 text-amber-700 border-amber-400/30"}, fuchsia:{pill:"bg-fuchsia-500/20 text-fuchsia-700 border-fuchsia-400/30"}, pink:{pill:"bg-pink-500/20 text-pink-700 border-pink-400/30"}, lime:{pill:"bg-lime-500/20 text-lime-700 border-lime-400/30"}, orange:{pill:"bg-orange-500/20 text-orange-700 border-orange-400/30"}, yellow:{pill:"bg-yellow-500/20 text-yellow-700 border-yellow-400/30"}, blue:{pill:"bg-blue-500/20 text-blue-700 border-blue-400/30"}, green:{pill:"bg-green-500/20 text-green-700 border-green-400/30"} }; return map[c]||map.slate; }

    // ===== Beep =====
    const beep=()=>{ const Ctx=window.AudioContext||window.webkitAudioContext; try{ const ctx=new Ctx(); const o=ctx.createOscillator(), g=ctx.createGain(); o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(ctx.destination); g.gain.setValueAtTime(0.18,ctx.currentTime); o.start(); o.stop(ctx.currentTime+0.15);}catch(e){} };

    // ===== Snackbar =====
    function useSnackbar(){ const [msg,setMsg]=React.useState(null); const show=(t,ms=2400)=>{ setMsg(t); setTimeout(()=>setMsg(null),ms); }; const Snackbar=()=> msg?(<div role="status" aria-live="polite" className="fixed bottom-5 left-1/2 -translate-x-1/2 z-50 px-4 py-3 rounded-full bg-slate-900/90 text-slate-100 border border-slate-700 shadow-2xl">{msg}</div>):null; return {show,Snackbar}; }

    // ===== Pomodoro =====
    const POMODORO={work:25*60,shortBreak:5*60,longBreak:15*60};
    function usePomodoroTimer(){ const [status,setStatus]=React.useState('stopped'); const [mode,setMode]=React.useState('work'); const [time,setTime]=React.useState(POMODORO.work); const ref=React.useRef(null);
      const start=React.useCallback(()=>setStatus('running'),[]); const pause=React.useCallback(()=>setStatus('paused'),[]); const reset=React.useCallback(()=>{setStatus('stopped');setMode('work');setTime(POMODORO.work);},[]); const setCustom=React.useCallback(m=>{ if(POMODORO[m]){ setMode(m); setTime(POMODORO[m]); setStatus('stopped');}},[]);
      React.useEffect(()=>{ if(status==='running'){ ref.current=setInterval(()=>{ setTime(p=>{ if(p<=1){ clearInterval(ref.current); setStatus('finished'); beep(); return 0;} return p-1;});},1000);} else if(ref.current){ clearInterval(ref.current);} return ()=> clearInterval(ref.current);},[status]);
      const fmt=s=>`${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`; return {time,formatted:fmt(time),status,mode,start,pause,reset,setCustom}; }

    // ===== Persistência / Recorrência =====
    const SCHEMA=2; // Versão do schema atualizada
    const weekKey=(a)=>`planner-week:${fmtISO(a)}?v=${SCHEMA}`;
    const SETTINGS_KEY=`planner-settings?v=${SCHEMA}`;
    const REC_KEY=`planner-recurring-tasks?v=${SCHEMA}`;
    const useDebouncedEffect=(fn,deps,ms=800)=>{ React.useEffect(()=>{ const t=setTimeout(()=>fn(),ms); return ()=>clearTimeout(t);},deps); };

    const prioRank={high:0,medium:1,low:2};
    const sortTasks=(arr=[])=> arr.slice().sort((a,b)=> (prioRank[a.priority||'medium']-prioRank[b.priority||'medium'])|| String(a.time||'').localeCompare(String(b.time||'')));

    // Nova lógica para injetar tarefas recorrentes na semana
    const processTasks = (currentTasks, recurringTasks, daysInWeek)=>{
      const newTasks = {...currentTasks};
      for(const rec of recurringTasks) {
          if(!rec.isMaster) continue;

          for(const day of daysInWeek) {
              const dayOfWeek = (day.getDay() + 6) % 7; // 0=Seg, 6=Dom
              if(rec.recurrenceDays.includes(dayOfWeek)) {
                  const dayISO = fmtISO(day);

                  // Verifica se uma instância já existe para evitar duplicação (pelo masterId)
                  const existingInstance = (newTasks[dayISO] || []).find(t => t.masterId === rec.id);

                  if(!existingInstance) {
                      const instance = {
                          id: genId(), // ID único para a instância
                          masterId: rec.id, // ID do mestre
                          title: rec.title,
                          time: rec.time || "",
                          note: rec.note || "",
                          category: rec.category || "",
                          priority: rec.priority || 'medium',
                          done: false,
                          isRecurring: true // Flag de hábito
                      };

                      newTasks[dayISO] = [...(newTasks[dayISO] || []), instance];
                  }
              }
          }
      }

      // Garante que todas as listas de tarefas (incluindo as injetadas) estejam ordenadas
      for(const key of Object.keys(newTasks)){
          newTasks[key] = sortTasks(newTasks[key]);
      }

      return newTasks;
    };

    // ===== Modal (foco inicial 1x) =====
    const Modal=({open,title,children,onClose,initialFocusRef})=>{
      const wasOpenRef=React.useRef(false);
      React.useEffect(()=>{
        document.body.style.overflow = open ? 'hidden' : '';
        const onKey=(e)=>{ if(e.key==='Escape' && open) onClose(); };
        window.addEventListener('keydown',onKey);
        return ()=> window.removeEventListener('keydown',onKey);
      },[open,onClose]);
      React.useEffect(()=>{
        if(open && !wasOpenRef.current){
          wasOpenRef.current=true;
          if(initialFocusRef?.current) initialFocusRef.current.focus();
        }
        if(!open) wasOpenRef.current=false;
      },[open,initialFocusRef]);
      if(!open) return null;
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4"
             role="dialog" aria-modal="true" aria-labelledby="modal-title"
             onKeyDownCapture={(e)=>e.stopPropagation()} onKeyUpCapture={(e)=>e.stopPropagation()}>
          <div className="absolute inset-0 bg-black/80 backdrop-blur-sm" onClick={onClose}/>
          <div className="relative w-full max-w-lg mx-auto rounded-xl border border-cyan-500/40 bg-slate-900 p-6 shadow-2xl shadow-cyan-900/40"
               onMouseDownCapture={(e)=>e.stopPropagation()}>
            <h2 id="modal-title" className="text-xl font-bold text-cyan-400 mb-3">{title}</h2>
            {children}
          </div>
        </div>
      );
    };

    // ===== App =====
    function App(){
      const [today]=React.useState(()=>new Date());
      const [anchor,setAnchor]=React.useState(()=>startOfWeek(new Date()));
      const [theme,setTheme]=React.useState(()=> (localStorage.getItem(SETTINGS_KEY)? JSON.parse(localStorage.getItem(SETTINGS_KEY)).theme : 'dark'));

      const [recurring,setRecurring]=React.useState(()=>{ const raw=localStorage.getItem(REC_KEY); return raw? JSON.parse(raw):[];});

      // Task initialization must happen after fetching recurring tasks
      const days=React.useMemo(()=> Array.from({length:7},(_,i)=>addDays(anchor,i)),[anchor]);
      
      const [tasks,setTasks]=React.useState(()=>{
        const weekStart = startOfWeek(new Date());
        const raw = localStorage.getItem(weekKey(weekStart));
        const initialTasks = raw ? JSON.parse(raw) : {};
        const initialDays = Array.from({length:7}, (_,i)=>addDays(weekStart,i));
        // Inject recurrence on initial load
        return processTasks(initialTasks, JSON.parse(localStorage.getItem(REC_KEY) || '[]'), initialDays);
      });

      const [dialog,setDialog]=React.useState(null);
      const [form,setForm]=React.useState({title:"",time:"",note:"",category:"",isRecurring:false,recurrenceDays:[],priority:'medium'});
      const [search,setSearch]=React.useState("");
      const [exportOpen,setExportOpen]=React.useState(false);
      const [saving,setSaving]=React.useState(false);
      const [headerCollapsed,setHeaderCollapsed]=React.useState(false);
      const [dragged,setDragged]=React.useState(null);
      const [focus,setFocus]=React.useState(null);

      const titleRef=React.useRef(null); // << foca só quando abrir

      const {show:toast,Snackbar}=useSnackbar();
      const pomodoro=usePomodoroTimer();

      React.useEffect(()=>{ document.documentElement.classList.toggle('dark',theme==='dark'); localStorage.setItem(SETTINGS_KEY,JSON.stringify({theme,_schema:SCHEMA})); },[theme]);

      const wKey=React.useMemo(()=>weekKey(anchor),[anchor]);
      
      // Efeito para carregar e processar tarefas recorrentes ao mudar a semana (anchor) ou a lista de recorrências
      React.useEffect(()=>{ 
          const raw=localStorage.getItem(wKey);
          const loadedTasks = raw? JSON.parse(raw):{};
          setTasks(processTasks(loadedTasks, recurring, days)); // Atualiza tarefas com as recorrências injetadas
      },[wKey, anchor, recurring, days]);

      // Efeitos de persistência
      useDebouncedEffect(()=>{ if(dialog||focus) return; setSaving(true); localStorage.setItem(wKey,JSON.stringify(tasks)); setSaving(false); },[wKey,tasks,dialog,focus],800);
      useDebouncedEffect(()=>{ if(dialog||focus) return; localStorage.setItem(REC_KEY,JSON.stringify(recurring)); },[recurring,dialog,focus],800);

      const matches=(t,q)=>{ if(!q) return true; const hay=`${t.title} ${t.note||""} ${t.category||""}`.toLowerCase(); return hay.includes(q.toLowerCase()); };
      
      const filtered=React.useMemo(()=>{ const out={}; for(const k of Object.keys(tasks)) out[k]=sortTasks(tasks[k]).filter(t=>matches(t,search)); return out; },[tasks,search]);

      const stats=React.useMemo(()=>{ let total=0,done=0; for(const arr of Object.values(tasks)) for(const t of (arr||[])){ total++; if(t.done) done++; } return {total,done,pct: total?Math.round(done/total*100):0}; },[tasks]);

      const addTask=(dateStr,t)=> setTasks(prev=>({...prev,[dateStr]:[...(prev[dateStr]||[]),t]}));
      const updateTask=(dateStr,id,partial)=> setTasks(prev=>({...prev,[dateStr]:(prev[dateStr]||[]).map(x=>x.id===id?{...x,...partial}:x)}));
      const toggleTask=(dateStr,id)=> setTasks(prev=>({...prev,[dateStr]:(prev[dateStr]||[]).map(x=>x.id===id?{...x,done:!x.done}:x)}));
      const removeTask=(dateStr,id)=> setTasks(prev=>({...prev,[dateStr]:(prev[dateStr]||[]).filter(x=>x.id!==id)}));

      const onDragStart=(e,date,id,index)=>{ setDragged({date,id,index}); e.dataTransfer.effectAllowed="move"; e.dataTransfer.setData("text/plain",id); };
      const onDragOver=(e)=>{ e.preventDefault(); if(dragged) e.dataTransfer.dropEffect="move"; };
      const onDragEnd=()=> setDragged(null);
      const onDrop=(e,targetDate,targetIndex)=>{ e.preventDefault(); if(!dragged){ setDragged(null); return; } setTasks(prev=>{ const {date:srcDate,id:mid}=dragged; const src=[...(prev[srcDate]||[])]; const si=src.findIndex(t=>t.id===mid); if(si===-1) return prev; const [moved]=src.splice(si,1); let tgt=srcDate===targetDate?src:[...(prev[targetDate]||[])]; tgt.splice(targetIndex,0,moved); const nt={...prev}; nt[srcDate]=src; nt[targetDate]=tgt; if(nt[srcDate] && nt[srcDate].length===0) delete nt[srcDate]; return nt; }); setDragged(null); };

      const openCreate=React.useCallback((dayDate)=>{ setForm({title:"",time:"",note:"",category:"",isRecurring:false,recurrenceDays:[(dayDate.getDay()+6)%7],priority:'medium'}); setDialog({date:fmtISO(dayDate),mode:"create"}); },[]);
      const openEdit=(dayISO,task)=>{ setForm({title:task.title||"",time:task.time||"",note:task.note||"",category:task.category||"",priority:task.priority||'medium',isRecurring:false,recurrenceDays:[]}); setDialog({date:dayISO,mode:"edit",id:task.id,isRecurringInstance:task.isRecurring}); };
      const openRecurrence=()=>{ setForm({title:"",time:"",note:"",category:"",isRecurring:true,recurrenceDays:[(days[0].getDay()+6)%7],priority:'medium'}); setDialog({date:fmtISO(days[0]),mode:"createRecurrence"}); };

      const submit=(e)=>{ e?.preventDefault?.(); if(!dialog||!form.title.trim()) return; const {title,time,note,category,priority,recurrenceDays}=form;
        if(dialog.mode==="create"){ const id=genId(); addTask(dialog.date,{id,title:title.trim(),time,note,category,priority,done:false}); } // Usando genId()
        else if(dialog.mode==="createRecurrence"){ if(!recurrenceDays.length){ toast("Selecione ao menos um dia."); return; } const id=genId(); setRecurring(prev=>[...prev,{id,title:title.trim(),time,note,category,recurrenceDays,priority,isMaster:true}]); toast("Hábito recorrente criado."); } // Usando genId()
        else if(dialog.mode==="edit"&&dialog.id){ updateTask(dialog.date,dialog.id,{title:title.trim(),time,note,category,priority}); toast("Tarefa atualizada."); }
        setDialog(null);
      };

      const doExportJSON=()=>{ const payload={version:SCHEMA,weekISO:fmtISO(anchor),tasks,recurring}; const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`planner-${fmtISO(anchor)}.json`; a.click(); URL.revokeObjectURL(a.href); toast("Backup JSON salvo."); };
      const doExportMarkdown=()=>{ const lines=[`# Semana ${fmtISO(anchor)}`]; for(const d of days){ const iso=fmtISO(d); const arr=(tasks[iso]||[]); lines.push(`\n## ${fmtHumano(d)} (${iso})`); for(const t of sortTasks(arr)){ lines.push(`- ${t.done?"[x]":"[ ]"} ${t.time?t.time+" ":""}${t.title} ${t.priority?`(prio: ${t.priority})`:""} ${t.category?`(cat: ${t.category})`:""}`); } } const blob=new Blob([lines.join("\n")],{type:"text/markdown"}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`planner-${fmtISO(anchor)}.md`; a.click(); URL.revokeObjectURL(a.href); toast("Diário Markdown exportado."); };
      const doExportCSV=()=>{ const header=["date","title","priority","category","time","done","note"]; const rows=[header.join(",")]; for(const d of days){ const iso=fmtISO(d); for(const t of (tasks[iso]||[])){ const r=[iso,JSON.stringify(t.title),t.priority||"",t.category||"",t.time||"",t.done,JSON.stringify(t.note||"")]; rows.push(r.join(",")); } } const blob=new Blob([rows.join("\n")],{type:"text/csv"}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`planner-${fmtISO(anchor)}.csv`; a.click(); URL.revokeObjectURL(a.href); toast("CSV exportado."); };
      const onImportFile=async(ev)=>{ const f=ev.target.files?.[0]; if(!f) return; const text=await f.text(); try{ const data=JSON.parse(text); if(!data||typeof data!=='object') throw new Error(); if(data.tasks) setTasks(processTasks(data.tasks, data.recurring || recurring, days)); if(data.recurring) setRecurring(data.recurring); toast("Dados importados."); }catch(e){ toast("Arquivo inválido."); } ev.target.value=""; };

      const startFocus=(date,id)=>{ const t=(tasks[date]||[]).find(x=>x.id===id); if(t){ setFocus({date,id,task:t}); pomodoro.reset(); } };

      // Lógica do atalho de teclado (Ctrl/Cmd + N e Ctrl/Cmd + K)
      React.useEffect(()=>{
        const handleKeydown = (e) => {
          if ((e.metaKey || e.ctrlKey) && e.key === 'n' && !dialog) { // Ctrl/Cmd + N para Nova Tarefa
            e.preventDefault();
            openCreate(days[0]); // Abre para o primeiro dia visível (Segunda)
          } else if ((e.metaKey || e.ctrlKey) && e.key === 'k') { // Ctrl/Cmd + K para Busca
            e.preventDefault();
            document.getElementById('busca')?.focus();
          }
        };
        window.addEventListener('keydown', handleKeydown);
        return () => window.removeEventListener('keydown', handleKeydown);
      },[days, dialog, openCreate]); // Depende de days e openCreate

      const themeClasses = theme==='dark'? {bg:"bg-slate-950",text:"text-slate-100",headerBg:"bg-slate-950/90",headerBorder:"border-slate-800",cardBg:"bg-slate-900",cardBorder:"border-slate-700",cardHover:"hover:border-slate-600",itemBg:"bg-slate-800/80",itemHover:"hover:bg-slate-800",neutral:"text-slate-400",inputBg:"bg-slate-800",inputBorder:"border-slate-700",inputFocus:"focus:border-cyan-500"} : {bg:"bg-slate-50",text:"text-slate-900",headerBg:"bg-white/90",headerBorder:"border-slate-200",cardBg:"bg-white",cardBorder:"border-slate-300",cardHover:"hover:border-slate-400",itemBg:"bg-slate-100",itemHover:"hover:bg-slate-200",neutral:"text-slate-500",inputBg:"bg-white",inputBorder:"border-slate-300",inputFocus:"focus:border-cyan-600"};
      const dayCardWidth="w-[90vw] sm:w-[50vw] lg:w-[40vw] xl:w-[25vw]";

      return (
        <div className={`min-h-screen ${themeClasses.bg} ${themeClasses.text}`}>
          {saving && <div className="pointer-events-none fixed top-0 right-0 m-4 z-50 px-3 py-1 text-xs rounded-full bg-cyan-600/70 text-white shadow-lg animate-pulse">Salvando...</div>}

          <header className={`sticky top-0 z-20 backdrop-blur ${themeClasses.headerBg} border-b ${themeClasses.headerBorder} shadow-xl`}>
            <div className="max-w-7xl mx-auto px-4 py-4 flex flex-wrap items-center gap-2">
              <div className="flex items-center gap-2 ml-auto">
                <button onClick={()=>setHeaderCollapsed(v=>!v)} className={`p-2 rounded-lg text-sm border ${themeClasses.cardBorder} ${themeClasses.inputBg} ${themeClasses.text} ${theme==='dark'?'hover:bg-slate-700':'hover:bg-slate-200'} transition shadow-md focus-ring`} title={headerCollapsed?"Mostrar métricas":"Ocultar métricas"}>
                  <span className="material-icons-round text-lg">{headerCollapsed?'open_in_full':'close_fullscreen'}</span>
                </button>
                <span className="material-icons-round text-2xl text-cyan-500">playlist_add_check</span>
                <h1 className="text-xl font-bold tracking-tight text-cyan-400">Planner Pro</h1>
              </div>
              <div className="flex items-center gap-2 ml-auto">
                <button onClick={()=>setTheme(t=>t==='dark'?'light':'dark')} className={`p-2 rounded-lg text-sm border transition shadow-md ${theme==='dark'?'border-slate-700 bg-slate-800 hover:bg-slate-700':'border-slate-300 bg-slate-100 hover:bg-slate-200 text-slate-700'} focus-ring`} title="Alternar tema">
                  <span className="material-icons-round text-lg">{theme==='dark'?'light_mode':'dark_mode'}</span>
                </button>
                <button onClick={openRecurrence} className="px-3 py-1.5 rounded-lg text-sm border border-violet-600 bg-violet-800/30 text-violet-300 hover:bg-violet-800/40 transition shadow-md flex items-center gap-1 focus-ring" title="Criar hábito recorrente">
                  <span className="material-icons-round text-base">repeat</span> Recorrência
                </button>
                <button onClick={()=>setExportOpen(true)} className="px-3 py-1.5 rounded-lg text-sm border border-emerald-600 bg-emerald-800/30 text-emerald-300 hover:bg-emerald-800/40 transition shadow-md flex items-center gap-1 focus-ring" title="Exportar / Importar">
                  <span className="material-icons-round text-base">backup</span> Dados
                </button>
                <button onClick={()=>setAnchor(d=>addDays(d,-7))} className={`p-2 rounded-lg text-sm border ${themeClasses.cardBorder} ${themeClasses.inputBg} ${themeClasses.text} ${theme==='dark'?'hover:bg-slate-700':'hover:bg-slate-200'} transition shadow-md focus-ring`}><span className="material-icons-round text-lg">chevron_left</span></button>
                <button onClick={()=>setAnchor(startOfWeek(new Date()))} className="px-3 py-1.5 rounded-lg text-sm border border-cyan-600 bg-cyan-800/30 text-cyan-300 hover:bg-cyan-800/40 transition shadow-md focus-ring">Hoje</button>
                <button onClick={()=>setAnchor(d=>addDays(d,7))} className={`p-2 rounded-lg text-sm border ${themeClasses.cardBorder} ${themeClasses.inputBg} ${themeClasses.text} ${theme==='dark'?'hover:bg-slate-700':'hover:bg-slate-200'} transition shadow-md focus-ring`}><span className="material-icons-round text-lg">chevron_right</span></button>
              </div>
            </div>

            <div className={`max-w-7xl mx-auto px-4 pb-4 grid grid-cols-1 md:grid-cols-3 gap-4 transition-all duration-300 ${headerCollapsed?'max-h-0 opacity-0 overflow-hidden':'max-h-[500px] opacity-100'}`}>
              <div className={`rounded-xl border ${themeClasses.headerBorder} ${themeClasses.cardBg} p-4 shadow-lg`}>
                <div className="flex items-center gap-4"><span className="material-icons-round text-3xl text-emerald-500">task_alt</span><div><div className="text-3xl font-extrabold text-emerald-500">{stats.done}</div><div className={`text-xs ${themeClasses.neutral}`}>Concluídas das {stats.total}</div></div></div>
                <div className={`mt-2 text-[11px] ${themeClasses.neutral}`}>Semana: {fmtISO(addDays(anchor,0))} → {fmtISO(addDays(anchor,6))}</div>
              </div>
              <div className={`rounded-xl border ${themeClasses.headerBorder} ${themeClasses.cardBg} p-4 shadow-lg`}>
                <div className="flex items-center gap-4"><span className="material-icons-round text-3xl text-amber-500">pending_actions</span><div><div className="text-3xl font-extrabold text-amber-500">{Math.max(stats.total-stats.done,0)}</div><div className={`text-xs ${themeClasses.neutral}`}>Pendentes</div></div></div>
              </div>
              <div className={`rounded-xl border ${themeClasses.headerBorder} ${themeClasses.cardBg} p-4 shadow-lg`}>
                <label className={`text-xs ${themeClasses.neutral} block mb-1`} htmlFor="busca">🔍 Busca Rápida (Ctrl/Cmd + K)</label>
                <input id="busca" value={search} onChange={(e)=>setSearch(e.target.value)} placeholder="Filtrar por título, nota ou categoria…" className={`w-full px-3 py-2 rounded-lg ${themeClasses.inputBg} border ${themeClasses.inputBorder} ${themeClasses.inputFocus} outline-none text-sm transition ${themeClasses.text}`} />
                {search.trim() && <p className="text-xs mt-1 text-orange-500">Atenção: a busca desativa a ordem manual!</p>}
              </div>
            </div>
          </header>

          <main className="max-w-7xl mx-auto px-4 py-8">
            <h2 className="text-lg font-semibold mb-4">Agenda da Semana (arraste e solte)</h2>
            <div className="flex overflow-x-scroll snap-x snap-mandatory pb-4 gap-4">
              {days.map((d)=>{
                const key=fmtISO(d); const arr=filtered[key]||[]; const isToday=fmtISO(d)===fmtISO(today);
                return (
                  <section key={key} className={`${isToday?"border-cyan-500 bg-cyan-500/10 shadow-xl shadow-cyan-900/20":"border-slate-700"} relative rounded-xl border-2 p-4 min-h-[500px] flex flex-col transition-all duration-300 snap-center flex-shrink-0 ${themeClasses.cardBg} ${themeClasses.cardHover} ${dayCardWidth}`} onDragOver={onDragOver} onDrop={(e)=>onDrop(e,key,arr.length)}>
                    <div className="flex items-center justify-between mb-3"><div className="font-semibold">{fmtHumano(d)}</div><div className="text-xs text-slate-400">{key}</div></div>
                    <div className="space-y-3 flex-grow overflow-y-auto pr-1">
                      {arr.map((t,idx)=>{
                        const cls=colorClass(t.category); const pri=PRIORITY[t.priority||'medium']; const isDragging=dragged&&dragged.id===t.id; const isFocus=focus&&focus.id===t.id&&focus.date===key;
                        return (
                          <article key={t.id} draggable onDragStart={(e)=>onDragStart(e,key,t.id,idx)} onDragOver={onDragOver} onDrop={(e)=>onDrop(e,key,idx)} onDragEnd={onDragEnd}
                            className={`rounded-lg border ${pri.ring} ${themeClasses.itemBg} p-3 flex items-start gap-3 relative transition-all duration-200 cursor-grab ${t.done? "opacity-60": themeClasses.itemHover} ${isDragging? "ring-4 ring-cyan-500/50 opacity-30 cursor-grabbing": "hover:shadow-lg hover:shadow-cyan-900/10"} ${isFocus? "ring-4 ring-cyan-500/80 !opacity-100": ""}`}>
                            <div className={`absolute left-0 top-0 bottom-0 w-1.5 rounded-l-lg ${pri.bar}`} />
                            <input type="checkbox" checked={t.done} onChange={()=>toggleTask(key,t.id)} className="mt-0.5 h-4 w-4 accent-emerald-500 flex-shrink-0 cursor-pointer border-slate-600 transition-transform duration-300 active:scale-90" aria-label="Concluir" />
                            <div className="flex-1 min-w-0 pt-0.5">
                              <div className={`text-sm break-words leading-tight ${t.done?"line-through text-slate-400 italic": ""}`}>{t.title}{t.isRecurring && <span className="ml-2 text-[10px] px-1 py-0.5 rounded-full bg-violet-500/10 text-violet-500 border border-violet-500/30">🔁 Hábito</span>}</div>
                              <div className="flex items-center gap-1 mt-1 flex-wrap">
                                {t.category && <span className={`text-[10px] px-1.5 py-0.5 rounded-full border ${cls.pill} whitespace-nowrap font-medium`}>{t.category}</span>}
                                {t.time && <div className="text-[11px] text-slate-400 truncate min-w-0">🕒 {t.time}</div>}
                              </div>
                            </div>
                            <div className="flex flex-col gap-1 text-xs flex-shrink-0 ml-auto pt-0.5">
                              <button onClick={()=>startFocus(key,t.id)} className="text-cyan-400 hover:text-cyan-300 transition" title="Modo Foco"><span className="material-icons-round text-lg">timer</span></button>
                              <button onClick={()=>openEdit(key,t)} className="text-cyan-300 hover:text-cyan-200 transition" title="Editar"><span className="material-icons-round text-lg">edit</span></button>
                              <button onClick={()=>removeTask(key,t.id)} className="text-rose-400 hover:text-rose-300 transition" title="Excluir"><span className="material-icons-round text-lg">delete</span></button>
                            </div>
                          </article>
                        );
                      })}
                    </div>
                    <button onClick={()=>openCreate(d)} className={`mt-4 w-full text-center text-sm text-cyan-400 border-2 border-dashed ${themeClasses.cardBorder} hover:border-cyan-600/60 rounded-xl px-3 py-2 ${theme==='dark'?'bg-slate-900/50 hover:bg-slate-800':'bg-slate-50 hover:bg-slate-100'} transition flex items-center justify-center gap-1`}>
                      <span className="material-icons-round text-base">add_box</span> Adicionar Tarefa (Ctrl/Cmd + N)
                    </button>
                  </section>
                );
              })}
            </div>
          </main>

          {/* Modal Criar/Editar/Recorrência */}
          <Modal
            open={!!dialog}
            title={dialog?.mode==="edit" ? "⚙️ Editar Tarefa" : dialog?.mode==="createRecurrence" ? "🔁 Novo Hábito Recorrente" : "➕ Adicionar Nova Tarefa"}
            onClose={()=>setDialog(null)}
            initialFocusRef={titleRef}
          >
            <form onSubmit={submit} className="space-y-3" onKeyDownCapture={(e)=>e.stopPropagation()}>
              <label className="block text-sm">
                <span className="text-slate-400">Título</span>
                <input
                  ref={titleRef}
                  autoComplete="off" spellCheck={false} inputMode="text"
                  value={form.title}
                  onChange={e=>setForm(f=>({...f,title:e.target.value}))}
                  className={`mt-1 w-full px-3 py-2 rounded-lg ${themeClasses.inputBg} border ${themeClasses.inputBorder} ${themeClasses.inputFocus} outline-none`} />
              </label>

              <div className="grid grid-cols-2 gap-3">
                <label className="block text-sm">
                  <span className="text-slate-400">Hora (opcional)</span>
                  <input
                    autoComplete="off" spellCheck={false} inputMode="text"
                    value={form.time}
                    onChange={e=>setForm(f=>({...f,time:e.target.value}))}
                    placeholder="08:30 ou texto livre"
                    className={`mt-1 w-full px-3 py-2 rounded-lg ${themeClasses.inputBg} border ${themeClasses.inputBorder} ${themeClasses.inputFocus} outline-none`} />
                </label>
              </div>

              <div className="grid grid-cols-2 gap-3">
                <label className="block text-sm">
                  <span className="text-slate-400">Categoria</span>
                  <select value={form.category} onChange={e=>setForm(f=>({...f,category:e.target.value}))}
                          className={`mt-1 w-full px-3 py-2 rounded-lg ${themeClasses.inputBg} border ${themeClasses.inputBorder} ${themeClasses.inputFocus} outline-none`}>
                    <option value="">(sem categoria)</option>
                    {CATEGORIES.map(c=> <option key={c} value={c}>{c}</option>)}
                  </select>
                </label>

                <label className="block text-sm">
                  <span className="text-slate-400">Prioridade</span>
                  <select value={form.priority} onChange={e=>setForm(f=>({...f,priority:e.target.value}))}
                          className={`mt-1 w-full px-3 py-2 rounded-lg ${themeClasses.inputBg} border ${themeClasses.inputBorder} ${themeClasses.inputFocus} outline-none`}>
                    <option value="high">Alta</option>
                    <option value="medium">Média</option>
                    <option value="low">Baixa</option>
                  </select>
                </label>
              </div>

              <label className="block text-sm">
                <span className="text-slate-400">Nota (opcional)</span>
                <textarea
                  autoComplete="off" spellCheck={false} rows={3}
                  value={form.note}
                  onChange={e=>setForm(f=>({...f,note:e.target.value}))}
                  className={`mt-1 w-full px-3 py-2 rounded-lg ${themeClasses.inputBg} border ${themeClasses.inputBorder} ${themeClasses.inputFocus} outline-none`} />
              </label>

              {dialog?.mode==="createRecurrence" && (
                <fieldset className="text-sm">
                  <legend className="text-slate-400 mb-1">Dias da semana</legend>
                  <div className="grid grid-cols-7 gap-2">
                    {["Seg","Ter","Qua","Qui","Sex","Sáb","Dom"].map((lbl,i)=>(
                      <label key={lbl} className="flex items-center gap-2 p-2 rounded-lg border border-slate-700 hover:border-cyan-600/60 cursor-pointer">
                        <input type="checkbox" checked={form.recurrenceDays.includes(i)}
                               onChange={()=>setForm(f=>({...f,recurrenceDays: f.recurrenceDays.includes(i)? f.recurrenceDays.filter(x=>x!==i) : [...f.recurrenceDays,i]}))}/>
                        <span>{lbl}</span>
                      </label>
                    ))}
                  </div>
                </fieldset>
              )}

              <div className="flex justify-end gap-2 pt-2">
                <button type="button" onClick={()=>setDialog(null)}
                        className={`px-3 py-2 rounded-lg border ${themeClasses.inputBorder} ${themeClasses.inputBg} ${theme==='dark'?'hover:bg-slate-700':'hover:bg-slate-200'} transition`}>Cancelar</button>
                <button type="submit" className="px-4 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-700 text-white font-semibold transition">Salvar</button>
              </div>
            </form>
          </Modal>

          {/* Backup / Export */}
          <Modal open={exportOpen} title="Backup e Exportação" onClose={()=>setExportOpen(false)}>
            <div className="space-y-3">
              <div className="grid grid-cols-2 gap-3">
                <button onClick={doExportJSON} className="px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white font-semibold transition">Exportar JSON</button>
                <label className="px-3 py-2 rounded-lg border border-slate-600 cursor-pointer text-center hover:border-cyan-600/60 transition">
                  Importar JSON
                  <input type="file" accept="application/json" onChange={onImportFile} className="hidden"/>
                </label>
              </div>
              <div className="grid grid-cols-2 gap-3">
                <button onClick={doExportMarkdown} className="px-3 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold transition">Exportar Markdown</button>
                <button onClick={doExportCSV} className="px-3 py-2 rounded-lg bg-sky-600 hover:bg-sky-700 text-white font-semibold transition">Exportar CSV</button>
              </div>
            </div>
          </Modal>

          {/* Modo Foco */}
          {focus && (
            <div className={`fixed inset-0 z-[60] flex items-center justify-center p-4 ${theme==='dark'?'bg-black/90':'bg-black/95'}`}>
              <button onClick={()=>{ setFocus(null); pomodoro.reset(); }} className="absolute top-4 right-4 text-white/80 hover:text-white transition text-xl font-bold" title="Sair do Modo Foco (Esc)">✕ Fechar</button>
              <div className={`relative w-full max-w-3xl p-8 rounded-2xl shadow-2xl ${theme==='dark'?'bg-slate-800':'bg-white'} border-4 border-cyan-500`}>
                <h3 className="text-2xl font-bold mb-4 text-cyan-500">Modo Foco / Pomodoro 🎯</h3>
                <div className="text-center mb-8">
                  <div className="flex justify-center gap-3 mb-4">
                    {['work','shortBreak','longBreak'].map(m=>(
                      <button key={m} onClick={()=>pomodoro.setCustom(m)} className={`px-4 py-2 rounded-full text-sm font-semibold transition ${pomodoro.mode===m?'bg-cyan-600 text-white shadow-md':`${themeClasses.inputBg} ${themeClasses.neutral} ${theme==='dark'?'hover:bg-slate-700':'hover:bg-slate-200'}`}`}>
                        {m==='work'?'Foco (25m)':m==='shortBreak'?'Pausa Curta (5m)':'Pausa Longa (15m)'}
                      </button>
                    ))}
                  </div>
                  <div className="text-8xl font-extrabold text-cyan-500 mb-4">{pomodoro.formatted}</div>
                  <div className="flex justify-center gap-4">
                    {pomodoro.status==='running'
                      ? <button onClick={pomodoro.pause} className="px-6 py-3 rounded-xl text-lg font-bold bg-amber-600 text-white hover:bg-amber-700 transition shadow-lg flex items-center gap-2"><span className="material-icons-round">pause</span> Pausar</button>
                      : <button onClick={pomodoro.start} className="px-6 py-3 rounded-xl text-lg font-bold bg-emerald-600 text-white hover:bg-emerald-700 transition shadow-lg flex items-center gap-2"><span className="material-icons-round">play_arrow</span> {pomodoro.status==='paused'?'Continuar':'Iniciar'}</button>}
                    <button onClick={pomodoro.reset} className={`px-4 py-2 rounded-xl text-md border ${themeClasses.inputBorder} ${themeClasses.inputBg} ${theme==='dark'?'hover:bg-slate-700':'hover:bg-slate-200'} transition ${themeClasses.text} flex items-center gap-2`}>
                      <span className="material-icons-round">restart_alt</span> Resetar
                    </button>
                  </div>
                </div>
                <div className={`rounded-lg p-6 border-l-8 mb-6 mt-8 ${PRIORITY[focus.task.priority||'medium'].bar} ${themeClasses.itemBg} shadow-inner`}>
                  <h4 className="text-3xl font-extrabold break-words mb-2">{focus.task.title}</h4>
                  {focus.task.note && <p className={`${themeClasses.neutral} text-lg`}>{focus.task.note}</p>}
                </div>
                <div className="flex justify-between items-center pt-4 border-t border-slate-700">
                  <button onClick={()=>{ toggleTask(focus.date,focus.id); setFocus(null); pomodoro.reset(); }} className="px-6 py-3 rounded-xl text-lg font-bold bg-emerald-600 text-white hover:bg-emerald-700 transition shadow-lg">
                    {focus.task.done ? "Desmarcar e Sair" : "✅ Concluir e Sair"}
                  </button>
                  <button onClick={()=>{ setFocus(null); pomodoro.reset(); }} className={`px-4 py-2 rounded-xl text-md border ${themeClasses.inputBorder} ${themeClasses.inputBg} ${theme==='dark'?'hover:bg-slate-700':'hover:bg-slate-200'} transition ${themeClasses.text}`}>Voltar à Agenda</button>
                </div>
              </div>
            </div>
          )}

          <footer className="max-w-7xl mx-auto px-4 pb-6 mt-12 border-t border-slate-800/50">
            <div className={`mt-6 text-center text-xs ${themeClasses.neutral}`}>
              * Salvamento local (localStorage) com debounce de 0.8s. Pressione <kbd>Ctrl/Cmd + K</kbd> para focar a busca ou <kbd>Ctrl/Cmd + N</kbd> para adicionar nova tarefa.
            </div>
          </footer>

          <Snackbar/>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>

  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js").catch(console.error);
      });
    }
  </script>
</body>
</html>
